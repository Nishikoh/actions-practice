# This is a basic workflow to help you get started with Actions

name: Notify Test

on:
  workflow_dispatch:
    inputs:
      status:
        description: 'success or fail'
        required: true
        default: 'success'

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  job-1:
    runs-on: ubuntu-latest
    steps:
      - name: Say Hello
        run: echo "Hello"
  job-2:
    runs-on: ubuntu-latest
    steps:
      - name: success
        if: ${{ github.event.inputs.status == 'success' }}
        run: return 0
      - name: fail
        if: ${{ github.event.inputs.status == 'fail' }}
        run: return 1
        
  slack-notify:
    name: Slack Notify
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [job-1, job-2]
    steps:
    - name: Set Variables on Success
      if: ${{ success() }}
      env:
        COLOR: green
        TEXT: Successfully
    - name: Set Variables on Fail
      if: ${{ failure() }}
      env:
        COLOR: red
        TEXT: Fail
    - name: Set COMMIT_MESSAGE
      run: echo ::set-env name=COMMIT_MESSAGE::$(echo "${{ github.event.head_commit.message }}" | tr '\n' ' ')
    - name: Slack Notification
      uses: tokorom/action-slack-incoming-webhook@main
      env:
        INCOMING_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      with:
        text: ${{env.Text}} automated deployment.
        attachments: |
          [
            {
              "color": "${{env.COLOR}}",
              "fields": [
                {
                  "title": "Commit Message",
                  "value": "${{ env.COMMIT_MESSAGE }}"
                },
                {
                  "title": "GitHub Actions URL",
                  "value": "${{ github.event.repository.url }}/actions/runs/${{ github.run_id }}"
                },
                {
                  "title": "Workflow Name",
                  "value": "${{ github.workflow }}"
                }
              ]
            }
          ]
